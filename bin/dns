#!/usr/bin/env ruby

require "rubygems"
require "rexec"
require "rexec/daemon"
require "rubydns"

YIPPEE_ROOT   = File.expand_path("../../", __FILE__)
CONFIG_FILE   = File.join(YIPPEE_ROOT, "config/dns.conf")
RESOLVER_FILE = "/etc/resolver/debug"

# TODO: Install
# Copy our resolver config to /etc/resolver
%x(sudo cp #{CONFIG_FILE} #{RESOLVER_FILE}) unless File.exist?(RESOLVER_FILE)

class MasqDNS < RExec::Daemon::Base
  @@var_directory = File.join(YIPPEE_ROOT, "var")

  def self.run
    RubyDNS.run_server(:listen => [[:udp, "127.0.0.1", 11233]]) do
      match("domain.debug", :A) { |t| t.respond!("127.0.0.1") }
    end
  end
end

MasqDNS.daemonize
